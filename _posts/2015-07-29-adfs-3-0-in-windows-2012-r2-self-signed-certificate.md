---
id: 319
title: 'ADFS 3.0 in Windows 2012 R2: Self Signed Certificate'
date: '2015-07-29T06:42:33+01:00'
author: Dimitri
layout: article
guid: 'http://dimitri.janczak.net/?p=319'
permalink: /2015/07/29/adfs-3-0-in-windows-2012-r2-self-signed-certificate/
tc-thumb-fld:
    - 'a:2:{s:9:"_thumb_id";s:3:"320";s:11:"_thumb_type";s:5:"thumb";}'
layout_key:
    - ''
post_slider_check_key:
    - '0'
image: /wp-content/uploads/2015/07/ADSFS-WIndows-2012-R2-Certificate-CNG-Key-Error.png
categories:
    - 'ADFS-AD Federation Services'
tags:
    - Certificate
    - CNG
    - PKI
    - 'Role Wizard'
    - 'SElf-signed Certificate'
---

A recent lab build showed me that in spite Microsoft’s evangelism for Powershell scripting, every product is not yet aligned and also made me discover a nice Powershell Module about PKI management.

The initial goal of my lab was to test the Active Directory Federation Services role from the Windows 2012 R2 release. As the wizard requests you to have a certificate, I genuinely told myself I can use this new [New-SelfSignedCertificate](https://technet.microsoft.com/en-us/library/hh848633%28v=wps.630%29.aspx) introduced in the very same OS.

Unfortunately after a couple of pages, the AD FS wizard yells at you with such a message:

[![ADSFS-WIndows-2012-R2-Certificate-CNG-Key-Error](http://dimitri.janczak.net/wp-content/uploads/2015/07/ADSFS-WIndows-2012-R2-Certificate-CNG-Key-Error.png)](http://dimitri.janczak.net/wp-content/uploads/2015/07/ADSFS-WIndows-2012-R2-Certificate-CNG-Key-Error.png)

 *The certificate with the specified thumbprint XXXX has a Cryptography Next Generation (CNG) private key. The certificates with the CNG private key are not supported. Use a certificate based on a key pair generated by a legacy Cryptographic Service Provider.*

Many web pages will tell you to manually craft a request from your CA, Certification Authority, and have it signed by a “simple” provider. Fortunately, there’s an easier method: just find a way to have a self signed certificate signed also with a simple provider. The Microsoft provided cmdlet however does not allow you to specify such option when called.

You have to call at the community and you may well be heard by installing the [PS PKI module at Codeplex](https://pspki.codeplex.com/). There’s a function called New-SelfSignedCertificateEx which allows to fill your request with the needed options. As far as our AD FS 3.0 requirements are concerned, the following command will do the trick:

```
<pre class="lang:ps decode:true " title="ADFS 3.0 Compatible Self-Signed Certificate">New-SelfSignedCertificateEx  -Subject 'CN=yourfederationname.yourdomain.com' -ProviderName "Microsoft Enhanced RSA and AES Cryptographic Provider"  -KeyLength 2048 -FriendlyName 'OAFED SelfSigned' -SignatureAlgorithm sha256 -EKU "Server Authentication", "Client authentication" -KeyUsage "KeyEncipherment, DigitalSignature" -Exportable -StoreLocation "LocalMachine"
```